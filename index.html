<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoopMeets</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f8ff;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #007BFF;
      text-align: center;
    }
    input, select, button {
      margin: 5px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      display: block;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #matchedLoops li {
      margin: 10px 0;
    }
    #authSection, #loopSection, #profileSection {
      max-width: 500px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h1>LoopMeets</h1>

  <div id="authSection">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="profileSection" style="display:none">
    <h2>Your Profile</h2>
    <p id="userEmail"></p>
    <h3>My Loops:</h3>
    <ul id="myLoops"></ul>
  </div>

  <div id="loopSection" style="display:none">
    <h2>Create a Loop</h2>
    <input type="text" id="loopTitle" placeholder="Loop Title">
    <input type="text" id="loopLocation" placeholder="Location">
    <input type="number" id="loopMax" placeholder="Max People">
    <input type="text" id="loopTags" placeholder="Tags (comma separated)">

    <h3>Your Travel Preferences</h3>
    <label for="prefClimate">Preferred Climate:</label>
    <select id="prefClimate">
      <option value="warm">Warm</option>
      <option value="cold">Cold</option>
      <option value="moderate">Moderate</option>
    </select>

    <label for="prefPace">Travel Pace:</label>
    <select id="prefPace">
      <option value="relaxed">Relaxed</option>
      <option value="balanced">Balanced</option>
      <option value="fast">Fast-Paced</option>
    </select>

    <label for="prefBudget">Budget:</label>
    <select id="prefBudget">
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>

    <input type="text" id="prefActivities" placeholder="Activities you like (comma separated)">

    <button onclick="createLoop()">Create Loop</button>
    <button onclick="matchLoopsAI()">Find Matched Loops</button>

    <h3>Matched Loops:</h3>
    <ul id="matchedLoops"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      onValue,
      push,
      child
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_lEYUVD1yP3vdde0JstOz4f3YhEbVaBk",
      authDomain: "loopmates-94b46.firebaseapp.com",
      databaseURL: "https://loopmates-94b46-default-rtdb.firebaseio.com",
      projectId: "loopmates-94b46",
      storageBucket: "loopmates-94b46.appspot.com",
      messagingSenderId: "336997321934",
      appId: "1:336997321934:web:3ffd0f1dbf6b3930e0149f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      document.getElementById('authSection').style.display = user ? 'none' : 'block';
      document.getElementById('loopSection').style.display = user ? 'block' : 'none';
      document.getElementById('profileSection').style.display = user ? 'block' : 'none';
      if (user) {
        document.getElementById('userEmail').innerText = `Logged in as: ${user.email}`;
        loadMyLoops(user.uid);
      }
    });

    function loadMyLoops(uid) {
      const myList = document.getElementById('myLoops');
      myList.innerHTML = '';
      get(ref(db, 'loops')).then(snapshot => {
        snapshot.forEach(child => {
          const loop = child.val();
          if (loop.joined && loop.joined.includes(uid)) {
            const li = document.createElement('li');
            li.textContent = `${loop.title} – ${loop.location}`;
            myList.appendChild(li);
          }
        });
      });
    }

    window.signup = function () {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => alert("Signed up successfully"))
        .catch(err => alert(err.message));
    }

    window.login = function () {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => alert("Logged in"))
        .catch(err => alert(err.message));
    }

    window.logout = function () {
      signOut(auth);
    }

    function expandWithSynonyms(keywords) {
      const synonyms = {
        hiking: ["trekking", "walking", "climbing"],
        beach: ["coast", "seaside", "shore"],
        relaxing: ["chill", "calm", "peaceful"],
        adventure: ["exploration", "thrill", "exciting"],
        sightseeing: ["tour", "exploring", "attractions"]
      };
      let expanded = [...keywords];
      keywords.forEach(word => {
        if (synonyms[word]) {
          expanded.push(...synonyms[word]);
        }
      });
      return [...new Set(expanded)];
    }

    window.matchLoopsAI = function () {
      const userClimate = document.getElementById('prefClimate').value.toLowerCase();
      const userPace = document.getElementById('prefPace').value.toLowerCase();
      const userBudget = document.getElementById('prefBudget').value.toLowerCase();
      const userActivities = document.getElementById('prefActivities').value.toLowerCase().split(/[,\s]+/).filter(Boolean);
      const expandedActivities = expandWithSynonyms(userActivities);

      const dbRef = ref(db, 'loops/');
      get(dbRef).then(snapshot => {
        const matched = [];
        snapshot.forEach(child => {
          const loop = child.val();
          loop.key = child.key;
          if (
            loop.climate === userClimate &&
            loop.pace === userPace &&
            loop.budget === userBudget &&
            loop.tags.some(tag => expandedActivities.includes(tag.toLowerCase()))
          ) {
            matched.push(loop);
          }
        });
        displayMatchedLoops(matched);
      });
    }

    window.displayMatchedLoops = function (loops) {
      const container = document.getElementById('matchedLoops');
      container.innerHTML = '';
      loops.forEach(loop => {
        const li = document.createElement('li');
        const full = loop.joined && loop.joined.length >= loop.maxPeople;
        li.textContent = `${loop.title} – ${loop.location} (${loop.tags.join(', ')}) ${full ? '[ALL BOOKED]' : ''}`;
        if (!full) {
          const joinBtn = document.createElement('button');
          joinBtn.textContent = "Join";
          joinBtn.onclick = () => joinLoop(loop.key);
          li.appendChild(joinBtn);
        }
        container.appendChild(li);
      });
    }

    window.joinLoop = function (loopKey) {
      const user = auth.currentUser;
      if (!user) return alert("Please log in to join a loop.");
      const loopRef = ref(db, `loops/${loopKey}/joined`);
      get(loopRef).then(snapshot => {
        let joined = snapshot.exists() ? snapshot.val() : [];
        if (!joined.includes(user.uid)) {
          joined.push(user.uid);
          set(loopRef, joined);
          alert("You joined the loop!");
          matchLoopsAI();
          loadMyLoops(user.uid);
        } else {
          alert("Already joined.");
        }
      });
    }

    window.createLoop = function () {
      const loop = {
        title: document.getElementById('loopTitle').value,
        location: document.getElementById('loopLocation').value,
        maxPeople: parseInt(document.getElementById('loopMax').value),
        tags: document.getElementById('loopTags').value.toLowerCase().split(',').map(t => t.trim()),
        climate: document.getElementById('prefClimate').value.toLowerCase(),
        pace: document.getElementById('prefPace').value.toLowerCase(),
        budget: document.getElementById('prefBudget').value.toLowerCase(),
        joined: []
      };
      const newRef = push(ref(db, 'loops'));
      set(newRef, loop);
      alert('Loop created!');
    }
  </script>
</body>
</html>
