<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoopMates.ai</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script type="module">
  import { initializeApp } from "firebase/app";

    const firebaseConfig = {
      apiKey: "AIzaSyC_lEYUVD1yP3vdde0JstOz4f3YhEbVaBk",
      authDomain: "loopmates-94b46.firebaseapp.com",
      databaseURL: "https://loopmates-94b46-default-rtdb.firebaseio.com",
      projectId: "loopmates-94b46",
      storageBucket: "loopmates-94b46.firebasestorage.app",
      messagingSenderId: "336997321934",
      appId: "1:336997321934:web:3ffd0f1dbf6b3930e0149f"
    };

    const app = initializeApp(firebaseConfig);
    window.app = app;
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f8fc;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #6887c4;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    header h1 {
      font-size: 3rem;
      margin: 0;
    }
    header p {
      font-size: 1.1rem;
      margin-top: 0.5rem;
    }
    .btn-primary {
      background-color: white;
      color: #6887c4;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 1rem;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #d0e3ff;
    }
    section {
      padding: 2rem;
      max-width: 900px;
      margin: auto;
    }
    input, button, textarea, select {
      font-family: inherit;
      font-size: 1rem;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    footer {
      background: #f1f1f1;
      padding: 1.5rem;
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      font-style: italic;
    }
    .profile-card {
      background: white;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>LoopMates.ai</h1>
    <p>Find short-term travel buddies for micro adventures.</p>
    <div id="userWelcome"></div>
    <button class="btn-primary" onclick="showAuth()">Login / Register</button>
    <button class="btn-primary" onclick="logout()">Logout</button>
    <button class="btn-primary" onclick="showProfile()">My Profile</button>
  </header>

  <section>
    <div id="auth" style="display:none;">
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <button onclick="register()">Register</button>
    </div>
  </section>

  <section class="profile-card" id="preferencesSection" style="display:none;">
    <h2>Tell us about your travel preferences</h2>
    <select id="activity">
      <option value="beach">Beach</option>
      <option value="hiking">Hiking</option>
      <option value="nightlife">Nightlife</option>
      <option value="culture">Culture</option>
    </select>
    <input id="tripLength" placeholder="Ideal trip length (days)">
    <select id="vibe">
      <option value="relaxing">Relaxing</option>
      <option value="adventurous">Adventurous</option>
      <option value="structured">Structured</option>
      <option value="spontaneous">Spontaneous</option>
    </select>
    <input id="groupSize" placeholder="Preferred group size">
    <input id="budget" placeholder="Budget range ($)">
    <textarea id="destinations" placeholder="Top destinations or bucket list places"></textarea>
    <button onclick="savePreferences()">Save Preferences</button>
  </section>

  <section class="profile-card" id="profileSection" style="display:none;">
    <h2>My Profile</h2>
    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
    <p><strong>My Loops Joined:</strong></p>
    <ul id="joinedLoops"></ul>
  </section>

  <footer>
    &copy; 2025 LoopMates.ai — Make friends, not just memories.
  </footer>

  <script type="module">
    import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

    const db = getDatabase(window.app);
    const auth = getAuth(window.app);

    window.showProfile = () => {
      const user = auth.currentUser;
      if (!user) return alert("Please login first");
      document.getElementById("profileSection").style.display = "block";
      document.getElementById("profileEmail").textContent = user.email;

      const joinedList = document.getElementById("joinedLoops");
      joinedList.innerHTML = "";

      onValue(ref(db, "loops"), snapshot => {
        snapshot.forEach(child => {
          const loop = child.val();
          if (loop.attendees?.includes(user.uid)) {
            const li = document.createElement("li");
            li.textContent = loop.title + " – " + loop.time;
            joinedList.appendChild(li);
          }
        });
      }, { onlyOnce: true });
    };

    window.savePreferences = () => {
      const user = auth.currentUser;
      if (!user) return alert("Login first");
      const prefs = {
        activity: document.getElementById("activity").value,
        tripLength: document.getElementById("tripLength").value,
        vibe: document.getElementById("vibe").value,
        groupSize: document.getElementById("groupSize").value,
        budget: document.getElementById("budget").value,
        destinations: document.getElementById("destinations").value
      };
      set(ref(db, `users/${user.uid}/preferences`), prefs);
      alert("Preferences saved!");
    };

    function advancedMatchUserToLoops(userPrefs, allLoops) {
      return allLoops
        .map(loop => {
          let score = 0;
          const loopText = `${loop.title} ${loop.description || ''}`.toLowerCase();

          if (loopText.includes(userPrefs.activity)) score += 2;
          if (loopText.includes(userPrefs.vibe)) score += 2;

          if (userPrefs.destinations) {
            userPrefs.destinations
              .toLowerCase()
              .split(',')
              .map(dest => dest.trim())
              .forEach(dest => {
                if (loopText.includes(dest)) score += 1.5;
              });
          }

          const loopBudget = parseInt(loop.budget) || 0;
          const userBudget = parseInt(userPrefs.budget) || 0;
          if (userBudget && Math.abs(userBudget - loopBudget) <= 200) score += 1;

          const loopGroupSize = parseInt(loop.groupSize) || 0;
          const userGroupSize = parseInt(userPrefs.groupSize) || 0;
          if (userGroupSize && Math.abs(userGroupSize - loopGroupSize) <= 2) score += 1;

          const loopTripLength = parseInt(loop.tripLength) || 0;
          const userTripLength = parseInt(userPrefs.tripLength) || 0;
          if (userTripLength && Math.abs(userTripLength - loopTripLength) <= 2) score += 1;

          return { ...loop, score };
        })
        .sort((a, b) => b.score - a.score)
        .filter(loop => loop.score >= 3);
    }

    function displayMatches() {
      const user = auth.currentUser;
      if (!user) return;
      onValue(ref(db, `users/${user.uid}/preferences`), snapshot => {
        const prefs = snapshot.val();
        if (!prefs) return;
        onValue(ref(db, 'loops'), loopsSnap => {
          const allLoops = [];
          loopsSnap.forEach(loopSnap => allLoops.push(loopSnap.val()));
          const matched = advancedMatchUserToLoops(prefs, allLoops);

          set(ref(db, `user-matches/${user.uid}`), matched);

          const results = document.createElement('div');
          results.innerHTML = `<h3>Matched Loops for You</h3><ul>${matched.map(l => `<li>${l.title} - ${l.time}</li>`).join('')}</ul>`;
          document.body.appendChild(results);
        });
      });
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("preferencesSection").style.display = "block";
        document.getElementById("userWelcome").textContent = `Welcome, ${user.email}`;
        displayMatches();
      }
    });

    window.showAuth = () => {
      document.getElementById("auth").style.display = "block";
    };

    window.logout = () => {
      signOut(auth);
      alert("Logged out");
      location.reload();
    };

    window.login = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    };

    window.register = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      createUserWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    };
  </script>
</body>
</html>
