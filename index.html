<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoopMeets</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #ffffff;
      color: #1a1a1a;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #007BFF;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    main {
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1, h2, h3 {
      color: #007BFF;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #007BFF;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    ul li {
      background-color: #f7f7f7;
      margin: 5px 0;
      padding: 10px;
      border-radius: 4px;
    }
    #authSection, #loopSection {
      margin-top: 20px;
    }
    #profileSection {
      margin-top: 30px;
      padding: 20px;
      background-color: #f2f2f2;
      border-radius: 6px;
    }
    .logout-btn {
      background-color: #e74c3c;
      margin-top: 10px;
    }
    .logout-btn:hover {
      background-color: #c0392b;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC_lEYUVD1yP3vdde0JstOz4f3YhEbVaBk",
      authDomain: "loopmates-94b46.firebaseapp.com",
      databaseURL: "https://loopmates-94b46-default-rtdb.firebaseio.com",
      projectId: "loopmates-94b46",
      storageBucket: "loopmates-94b46.appspot.com",
      messagingSenderId: "336997321934",
      appId: "1:336997321934:web:3ffd0f1dbf6b3930e0149f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    const authSection = document.getElementById('authSection');
    const loopSection = document.getElementById('loopSection');
    const matchedLoopsEl = document.getElementById('matchedLoops');
    const myLoopsEl = document.getElementById('myLoops');

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => location.reload())
        .catch(error => alert(error.message));
    }

    function signup() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => location.reload())
        .catch(error => alert(error.message));
    }

    function logout() {
      signOut(auth).then(() => location.reload());
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        authSection.style.display = 'none';
        loopSection.style.display = 'block';
        loadMyLoops(user.uid);
      } else {
        authSection.style.display = 'block';
        loopSection.style.display = 'none';
      }
    });

    function createLoop() {
      const title = document.getElementById('loopTitle').value;
      const location = document.getElementById('loopLocation').value;
      const max = parseInt(document.getElementById('loopMax').value);
      const tags = document.getElementById('loopTags').value.split(',').map(t => t.trim().toLowerCase());
      const prefClimate = document.getElementById('prefClimate').value;
      const prefPace = document.getElementById('prefPace').value;
      const prefBudget = document.getElementById('prefBudget').value;
      const prefActivities = document.getElementById('prefActivities').value.split(',').map(t => t.trim().toLowerCase());
      const user = auth.currentUser;
      const loopRef = push(ref(db, 'loops'));
      set(loopRef, {
        title,
        location,
        max,
        tags,
        createdBy: user.uid,
        participants: [user.uid],
        preferences: { climate: prefClimate, pace: prefPace, budget: prefBudget, activities: prefActivities }
      });
    }

    function matchLoopsAI() {
      const prefClimate = document.getElementById('prefClimate').value;
      const prefPace = document.getElementById('prefPace').value;
      const prefBudget = document.getElementById('prefBudget').value;
      const prefActivities = document.getElementById('prefActivities').value.split(',').map(t => t.trim().toLowerCase());
      const user = auth.currentUser;
      get(ref(db, 'loops')).then(snapshot => {
        matchedLoopsEl.innerHTML = '';
        snapshot.forEach(child => {
          const loop = child.val();
          const match =
            loop.preferences.climate === prefClimate &&
            loop.preferences.pace === prefPace &&
            loop.preferences.budget === prefBudget &&
            prefActivities.some(a => loop.preferences.activities.includes(a));
          if (match) {
            const li = document.createElement('li');
            li.textContent = `${loop.title} in ${loop.location} ${loop.participants.length >= loop.max ? '(ALL BOOKED)' : ''}`;
            if (loop.participants.includes(user.uid)) {
              li.style.fontWeight = 'bold';
            } else if (loop.participants.length < loop.max) {
              const joinBtn = document.createElement('button');
              joinBtn.textContent = 'Join';
              joinBtn.onclick = () => {
                loop.participants.push(user.uid);
                set(ref(db, 'loops/' + child.key), loop);
                loadMyLoops(user.uid);
              };
              li.appendChild(joinBtn);
            }
            matchedLoopsEl.appendChild(li);
          }
        });
      });
    }

    function loadMyLoops(uid) {
      get(ref(db, 'loops')).then(snapshot => {
        myLoopsEl.innerHTML = '';
        snapshot.forEach(child => {
          const loop = child.val();
          if (loop.participants && loop.participants.includes(uid)) {
            const li = document.createElement('li');
            li.textContent = `${loop.title} in ${loop.location}`;
            myLoopsEl.appendChild(li);
          }
        });
      });
    }

    window.login = login;
    window.signup = signup;
    window.logout = logout;
    window.createLoop = createLoop;
    window.matchLoopsAI = matchLoopsAI;
  </script>
</head>
<body>
  <header>
    <h1>LoopMeets</h1>
  </header>
  <main>
    <div id="authSection">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <button onclick="signup()">Sign Up</button>
    </div>

    <div id="loopSection" style="display:none">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h2>Create a Loop</h2>
      <input type="text" id="loopTitle" placeholder="Loop Title">
      <input type="text" id="loopLocation" placeholder="Location">
      <input type="number" id="loopMax" placeholder="Max People">
      <input type="text" id="loopTags" placeholder="Tags (comma separated)">

      <h3>Your Travel Preferences</h3>
      <label for="prefClimate">Preferred Climate:</label>
      <select id="prefClimate">
        <option value="warm">Warm</option>
        <option value="cold">Cold</option>
        <option value="moderate">Moderate</option>
      </select>

      <label for="prefPace">Travel Pace:</label>
      <select id="prefPace">
        <option value="relaxed">Relaxed</option>
        <option value="balanced">Balanced</option>
        <option value="fast">Fast-Paced</option>
      </select>

      <label for="prefBudget">Budget:</label>
      <select id="prefBudget">
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>

      <input type="text" id="prefActivities" placeholder="Activities you like (comma separated)">

      <button onclick="createLoop()">Create Loop</button>
      <button onclick="matchLoopsAI()">Find Matched Loops</button>

      <h3>Matched Loops:</h3>
      <ul id="matchedLoops"></ul>

      <div id="profileSection">
        <h3>My Loops</h3>
        <ul id="myLoops"></ul>
      </div>
    </div>
  </main>
</body>
</html>
